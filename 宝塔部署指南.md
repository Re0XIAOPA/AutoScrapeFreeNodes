# 宝塔面板部署指南

本指南将帮助您使用宝塔面板将免费节点订阅集合网站部署到您的服务器上。

## 一、准备工作

### 1. 环境要求

- 已安装宝塔面板的服务器
- 支持 Nginx/Apache 服务器
- Node.js 14+ (如需动态更新数据)

### 2. 部署方式选择

项目支持两种部署方式：
- **静态部署**：只需要一个 Web 服务器，无需 Node.js 环境（简单，推荐）
- **动态部署**：需要 Node.js 环境，可实时抓取更新数据（灵活，但复杂）

## 二、静态部署方式（推荐）

### 1. 下载项目并构建静态文件

```bash
# 克隆项目
git clone https://github.com/yourusername/AutoScrapeFreeNodes.git
cd AutoScrapeFreeNodes

# 安装依赖
npm install

# 构建静态文件
node scripts/local-build-test.js
```

构建完成后，将会在 `dist` 目录生成所有静态文件。

### 2. 上传文件到服务器

1. 登录宝塔面板
2. 进入"文件"管理
3. 创建网站目录，例如：`/www/wwwroot/freesub`
4. 上传本地 `dist` 目录中的所有文件到该目录

### 3. 创建网站

1. 在宝塔面板，进入"网站"页面
2. 点击"添加站点"
3. 填写以下信息：
   - 域名：您的域名（如：sub.yourdomain.com）
   - 网站目录：选择刚才上传文件的目录
   - PHP版本：纯静态，PHP版本选择"纯静态"
   - SSL：建议开启 HTTPS（提高安全性）
4. 点击"提交"创建网站

### 4. 配置伪静态（重要）

1. 点击网站的"设置"按钮
2. 选择"伪静态"选项
3. 选择"其他"类型
4. 添加以下规则：

```
location / {
  try_files $uri $uri/ /index.html;
}
```

5. 保存配置

### 5. 配置定时更新（可选）

如果您希望定期更新数据，可以设置定时任务：

1. 在宝塔面板中，进入"计划任务"
2. 点击"添加计划任务"
3. 设置以下信息：
   - 任务名称：更新节点数据
   - 执行周期：每天
   - 指定时间：00:30
   - 脚本内容：
   ```bash
   cd /path/to/AutoScrapeFreeNodes && node scraper.js && node scripts/build-gh-pages.js && \
   cp -r dist/* /www/wwwroot/freesub/
   ```
4. 点击"提交"创建计划任务

## 三、动态部署方式

### 1. 安装 Node.js 环境

1. 在宝塔面板，进入"软件商店"
2. 搜索并安装 "PM2管理器" 和 "Node.js版本管理器"
3. 通过 Node.js 版本管理器安装 Node.js 14+ 版本

### 2. 上传项目文件

1. 登录宝塔面板
2. 进入"文件"管理
3. 创建项目目录，例如：`/www/wwwroot/freesub-app`
4. 上传完整项目代码到该目录（除了 `node_modules` 和 `dist` 目录）

### 3. 安装依赖并启动应用

1. 在宝塔面板，进入"终端"
2. 执行以下命令：

```bash
cd /www/wwwroot/freesub-app
npm install
pm2 start index.js --name "freesubscription"
```

### 4. 配置网站和反向代理

1. 在宝塔面板，创建新网站
2. 点击网站的"设置"按钮
3. 选择"反向代理"选项
4. 添加反向代理规则：
   - 代理名称：freesubproxy
   - 目标URL：http://127.0.0.1:3001
5. 保存配置

## 四、故障排除

### 1. 解决 "ENV_CONFIG is not defined" 错误

如果遇到 `ENV_CONFIG is not defined` 错误，可能是由于以下原因：

1. 文件缓存问题：
   - 清除浏览器缓存
   - 添加版本号参数：修改 `index.html` 中的脚本引用，如 `config.js?v=1.0.1`

2. 文件加载顺序问题：
   - 确保 `config.js` 在 `app.js` 之前加载
   - 检查 HTML 文件中脚本标签的顺序

3. 文件路径问题：
   - 检查文件路径是否正确
   - 确保所有文件都已上传

### 2. 解决数据加载失败问题

如果网站可以打开但无法加载数据，请检查：

1. 控制台错误信息
2. 确认 `data` 和 `json` 目录下的数据文件是否存在
3. 尝试手动运行抓取脚本：`node scraper.js`

### 3. 宝塔面板权限问题

如果遇到权限问题，请在宝塔面板中：

1. 进入"文件"管理，选择网站目录
2. 点击"权限" → "755"（目录）和"644"（文件）
3. 选择"应用到子目录"，确认修改

## 五、优化建议

### 1. 开启 HTTPS

1. 在宝塔面板网站设置中申请免费的 SSL 证书
2. 开启强制 HTTPS

### 2. 启用 Gzip 压缩

1. 在宝塔面板网站设置中，找到"配置文件"
2. 添加以下配置：

```
gzip on;
gzip_min_length 1k;
gzip_comp_level 6;
gzip_types text/plain text/css application/json application/javascript;
```

### 3. 设置缓存策略

为静态资源设置合理的缓存策略：

```
location ~* \.(css|js|jpg|jpeg|png|gif|ico)$ {
    expires 7d;
}

location ~* \.(json)$ {
    expires 1h;
}
```

## 六、更新维护

### 1. 手动更新

```bash
# 进入项目目录
cd /www/wwwroot/freesub-app

# 拉取最新代码
git pull

# 重新构建（静态部署）
node scripts/build-gh-pages.js
cp -r dist/* /www/wwwroot/freesub/

# 或重启应用（动态部署）
npm install
pm2 restart freesubscription
```

### 2. 自动更新

创建一个定时任务，定期从 GitHub 拉取最新代码并重新部署。

## 七、备份与恢复

### 1. 数据备份

```bash
# 备份数据目录
cp -r /www/wwwroot/freesub/data /backup/freesub_data_$(date +%Y%m%d)
```

### 2. 网站备份

使用宝塔面板的网站备份功能，定期创建完整备份。

---

如有任何问题，请参考项目 GitHub 仓库的文档或提交 Issue。 