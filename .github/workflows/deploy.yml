name: 部署免费节点抓取工具到GitHub Pages

on:
  # 自动执行的时间，每4小时运行一次
  schedule:
    - cron: '0 */4 * * *'
  
  # 当push到main分支时也执行
  push:
    branches: [ main ]
  
  # 允许手动触发工作流
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      # 检出仓库代码
      - name: 检出代码
        uses: actions/checkout@v2
        
      # 设置Node.js环境
      - name: 设置Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          
      # 安装依赖
      - name: 安装依赖
        run: npm install
        
      # 执行抓取和生成静态网站
      - name: 生成静态网站
        run: node generate-static.js
        
      # 部署到GitHub Pages
      - name: 部署到GitHub Pages
        uses: JamesIves/github-pages-deploy-action@4.1.5
        with:
          branch: gh-pages  # 部署到gh-pages分支
          folder: dist      # 使用dist目录作为源目录
          clean: true       # 清理旧文件
      
      # 提交最新数据到主分支
      - name: 提交最新数据
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/*.json
          git diff --quiet && git diff --staged --quiet || git commit -m "自动更新: 更新节点数据 [skip ci]"
          git push 